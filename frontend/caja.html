<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Caja</title>
  <link rel="stylesheet" href="styles/admin.css">
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f9f9f9;
      padding: 30px;
      color: #333;
    }
    h1 {
      color: #0984e3;
      text-align: center;
    }
    .filtros {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 20px 0;
    }
    input[type="date"],
    select {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 20px;
      background-color: #0984e3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background-color: #065cb4;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    }
    th,
    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background: #0984e3;
      color: white;
    }
    .acciones {
      text-align: center;
      margin-top: 20px;
    }
    .total {
      font-size: 1.2em;
      font-weight: bold;
      color: #0984e3;
      margin-top: 15px;
      text-align: right;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="admin.html" id="nav-productos">Productos</a></li>
        <li><a href="caja.html" id="nav-caja">Caja</a></li>
        <li><a href="cierre_caja.html" id="nav-cierre_caja">Cierre Caja</a></li>
        <li><button id="logoutBtn">Cerrar sesi√≥n</button></li>
      </ul>
    </nav>
  </header>
  <h1>üì¶ Caja</h1>
  <div class="filtros">
    <label for="fecha">Seleccionar fecha:</label>
    <input type="date" id="fecha" />
    <button id="buscar">Buscar √ìrdenes</button>
    <!--<button id="reporteDiario">üìÖ Reporte Diario (PDF)</button>
    <button id="reporteMensual">üóìÔ∏è Reporte Mensual (PDF)</button>-->
  </div>
  <table id="tablaOrdenes">
    <thead>
      <tr>
        <th>Mesa</th>
        <th>Productos y Recomendaciones</th>
        <th>Total</th>
        <th>Fecha</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="total" id="totalDia"></div>
  <!-- üßæ Modal de edici√≥n con scroll -->
  <div id="modalEditar" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:9999;">
    <div style="background:#fff; padding:25px; border-radius:10px; width:450px; max-height:80vh; overflow-y:auto; position:relative; box-shadow:0 4px 12px rgba(0,0,0,0.3);">
      <h3 style="text-align:center; color:#0984e3;">Editar Orden</h3>
      <label>Mesa:</label>
      <input type="text" id="editMesa" class="input-edit" style="width:100%; margin-bottom:10px;">
      <label>Total:</label>
      <input type="number" id="editTotal" class="input-edit" style="width:100%; margin-bottom:10px;">
      <label>Fecha:</label>
      <input type="date" id="editFecha" class="input-edit" style="width:100%; margin-bottom:10px;">
      <h4 style="margin-top:15px;">üõí Productos</h4>
      <div id="productosEditarContainer" style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; border-radius:6px; margin-bottom:15px;">
        <h4>üìã Cat√°logo</h4>
      <select id="selectProductos"></select>
      <button id="btnAgregarCatalogo">Agregar</button>

      </div>
      <div style="text-align:right; margin-top:10px;">
        <button id="guardarCambios">Guardar</button>
        <button id="cancelarEdicion" style="background:#ccc; margin-left:10px;">Cancelar</button>
      </div>
    </div>
  </div>
  <div class="acciones">
    <button id="cerrarCaja">Cerrar Caja</button>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script type="module">
    import { API_BASE } from "./config.js";

    const fechaInput = document.getElementById("fecha");
    const buscarBtn = document.getElementById("buscar");
    const cerrarCajaBtn = document.getElementById("cerrarCaja");
    const tablaBody = document.querySelector("#tablaOrdenes tbody");
    const totalDiaDiv = document.getElementById("totalDia");
    const logoutBtn = document.getElementById("logoutBtn");
    //const reporteDiarioBtn = document.getElementById("reporteDiario");
    //const reporteMensualBtn = document.getElementById("reporteMensual");

    // Modal elementos
    const modalEditar = document.getElementById("modalEditar");
    const editMesa = document.getElementById("editMesa");
    const editTotal = document.getElementById("editTotal");
    const editFecha = document.getElementById("editFecha");
    const guardarCambios = document.getElementById("guardarCambios");
    const cancelarEdicion = document.getElementById("cancelarEdicion");
    const contenedorProductos = document.getElementById("productosEditarContainer");

    // üîπ contenedor para productos en el modal
    let ordenActual = null;
    let itemsEditando = [];


    // üîì Cerrar sesi√≥n
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "login.html";
    });

    // üß≠ Capturar fecha desde URL (?fecha=YYYY-MM-DD)
    window.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const fechaURL = params.get("fecha");
      if (fechaURL) {
        fechaInput.value = fechaURL;
        buscarOrdenesPorFecha(fechaURL);
      }
    });

    // üîç Buscar √≥rdenes por fecha
    async function buscarOrdenesPorFecha(fechaSeleccionada) {
      if (!fechaSeleccionada) {
        alert("Por favor selecciona una fecha.");
        return;
      }
      try {
        const fechaISO = new Date(`${fechaSeleccionada}T00:00:00-05:00`).toISOString().split("T")[0];
        const response = await fetch(`${API_BASE}/por-fecha/${fechaISO}`);
        if (!response.ok) throw new Error(await response.text());
        const ordenes = await response.json();
        if (!Array.isArray(ordenes) || ordenes.length === 0) {
          tablaBody.innerHTML = `<tr><td colspan="5">No se encontraron √≥rdenes para esa fecha</td></tr>`;
          totalDiaDiv.textContent = "";
          return;
        }
        renderOrdenes(ordenes);
      } catch (error) {
        console.error("Error al buscar √≥rdenes:", error);
        alert("‚ùå Error al buscar las √≥rdenes del d√≠a.");
      }
    }

    buscarBtn.addEventListener("click", () => {
      buscarOrdenesPorFecha(fechaInput.value);
    });

    // üßæ Renderizar √≥rdenes con botones de acci√≥n
    function renderOrdenes(ordenes) {
      tablaBody.innerHTML = "";
      let total = 0;
      ordenes.forEach((orden) => {
        const fila = document.createElement("tr");
        const productos = orden.items
          .map(
            (p) =>
              `${p.nombre} (${p.cantidad})${
                p.recomendaciones ? " ‚Äî üìù " + p.recomendaciones : ""
              }`
          )
          .join("<br>");
        const fechaLocal = new Date(orden.createdAt).toLocaleDateString("es-CO", {
          timeZone: "America/Bogota",
        });

        // Crear botones
        // Crear botones
        const btnEditar = document.createElement("button");
        btnEditar.textContent = "Editar";
        btnEditar.style.marginRight = "5px";
        btnEditar.addEventListener("click", () => abrirModalEdicion(orden));

        const btnEliminar = document.createElement("button");
        btnEliminar.textContent = "Eliminar";
        btnEliminar.style.background = "red";
        btnEliminar.style.color = "white";
        btnEliminar.style.marginRight = "5px";
        btnEliminar.addEventListener("click", () => eliminarOrden(orden._id));

        // NUEVO BOT√ìN: IMPRIMIR FACTURA
        const btnImprimir = document.createElement("button");
        btnImprimir.textContent = "Imprimir Factura";
        btnImprimir.style.background = "#2ecc71";
        btnImprimir.style.color = "white";
        btnImprimir.addEventListener("click", () => imprimirFactura(orden._id));

        const celdaAcciones = document.createElement("td");
        celdaAcciones.appendChild(btnEditar);
        celdaAcciones.appendChild(btnEliminar);
        celdaAcciones.appendChild(btnImprimir);
        // Crear fila
        fila.innerHTML = `
          <td>${orden.mesa || "N/A"}</td>
          <td>${productos}</td>
          <td>$${orden.total.toLocaleString()}</td>
          <td>${fechaLocal}</td>
        `;
        fila.appendChild(celdaAcciones);
        tablaBody.appendChild(fila);
        total += orden.total;
      });
      totalDiaDiv.textContent = `Total del d√≠a: $${total.toLocaleString()}`;
    }

function abrirModalEdicion(orden) {
  ordenActual = orden;
  itemsEditando = JSON.parse(JSON.stringify(orden.items));

  editMesa.value = orden.mesa || "";
  editFecha.value = orden.fecha?.split("T")[0] || "";

  cargarCatalogo();   // üî• AQU√ç
  renderProductos();
  calcularTotal();

  modalEditar.style.display = "flex";
}


function renderProductos() {
  contenedorProductos.innerHTML = "";

  itemsEditando.forEach((item, index) => {
    const div = document.createElement("div");
    div.style.border = "1px solid #ccc";
    div.style.padding = "8px";
    div.style.marginBottom = "6px";

    const inputNombre = document.createElement("input");
    inputNombre.value = item.nombre;
    inputNombre.placeholder = "Nombre";
    inputNombre.addEventListener("input", e => {
      itemsEditando[index].nombre = e.target.value;
    });

    const inputCantidad = document.createElement("input");
    inputCantidad.type = "number";
    inputCantidad.min = 1;
    inputCantidad.value = item.cantidad;
    inputCantidad.addEventListener("input", e => {
      itemsEditando[index].cantidad = Number(e.target.value);
      calcularTotal();
    });

    const inputPrecio = document.createElement("input");
    inputPrecio.type = "number";
    inputPrecio.min = 0;
    inputPrecio.value = item.precio || 0;
    inputPrecio.addEventListener("input", e => {
      itemsEditando[index].precio = Number(e.target.value);
      calcularTotal();
    });

    const inputRec = document.createElement("input");
    inputRec.placeholder = "Recomendaciones";
    inputRec.value = item.recomendaciones || "";
    inputRec.addEventListener("input", e => {
      itemsEditando[index].recomendaciones = e.target.value;
    });

    const btnEliminar = document.createElement("button");
    btnEliminar.textContent = "üóë";
    btnEliminar.addEventListener("click", () => {
      itemsEditando.splice(index, 1);
      renderProductos();
      calcularTotal();
    });

    div.append(inputNombre, inputCantidad, inputPrecio, inputRec, btnEliminar);
    contenedorProductos.appendChild(div);
  });

  const btnAgregar = document
  .getElementById("btnAgregarCatalogo")
  .addEventListener("click", () => {
    const producto = JSON.parse(selectProductos.value);

    const existente = itemsEditando.find(p => p.nombre === producto.nombre);

    if (existente) {
      existente.cantidad++;
    } else {
      itemsEditando.push({
        nombre: producto.nombre,
        precio: producto.precio,
        cantidad: 1,
        recomendaciones: ""
      });
    }

    renderProductos();
    calcularTotal();
  });

}

const selectProductos = document.getElementById("selectProductos");

async function cargarCatalogo() {
  const res = await fetch(`${API_BASE}/productos`);
  const productos = await res.json();

  selectProductos.innerHTML = "";

  productos.forEach(p => {
    const opt = document.createElement("option");
    opt.value = JSON.stringify(p);
    opt.textContent = `${p.nombre} - $${p.precio}`;
    selectProductos.appendChild(opt);
  });
}


function agregarProducto() {
  itemsEditando.push({
    nombre: "",
    cantidad: 1,
    precio: 0,
    recomendaciones: ""
  });

  renderProductos();
}

function calcularTotal() {
  const total = itemsEditando.reduce(
    (sum, item) => sum + item.cantidad * item.precio,
    0
  );
  editTotal.value = total;
}

guardarCambios.addEventListener("click", async () => {
  if (!ordenActual) return;

  const datosActualizados = {
    mesa: editMesa.value,
    fecha: editFecha.value,
    items: itemsEditando,
    total: Number(editTotal.value)
  };

  try {
    const res = await fetch(`${API_BASE}/${ordenActual._id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(datosActualizados)
    });

    if (!res.ok) throw new Error(await res.text());

    alert("‚úÖ Orden actualizada");
    modalEditar.style.display = "none";
    buscarOrdenesPorFecha(fechaInput.value);
  } catch (err) {
    console.error(err);
    alert("‚ùå Error al actualizar la orden");
  }
});


function eliminarProducto(index) {
  itemsEditando.splice(index, 1);
  renderProductos();
  calcularTotal();
}

const datosActualizados = {
  mesa: editMesa.value,
  fecha: editFecha.value,
  items: itemsEditando,
  total: Number(editTotal.value)
};


    // üóëÔ∏è Eliminar orden
    async function eliminarOrden(id) {
      const confirmar = confirm("¬øSeguro que deseas eliminar esta orden?");
      if (!confirmar) return;
      try {
        const response = await fetch(`${API_BASE}/${id}`, {
          method: "DELETE",
        });
        if (!response.ok) throw new Error(await response.text());
        alert("üóëÔ∏è Orden eliminada correctamente");
        buscarOrdenesPorFecha(fechaInput.value);
      } catch (error) {
        console.error("Error eliminando orden:", error);
        alert("‚ùå No se pudo eliminar la orden.");
      }
    }

    // üí∞ Cerrar caja
    cerrarCajaBtn.addEventListener("click", async () => {
      const fechaSeleccionada = fechaInput.value;
      if (!fechaSeleccionada) return alert("Selecciona una fecha antes de cerrar la caja.");
      const confirmacion = confirm(
        `¬øSeguro que deseas cerrar la caja del d√≠a ${fechaSeleccionada}?`
      );
      if (!confirmacion) return;
      try {
        const response = await fetch(`${API_BASE}/cerrar-caja`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fecha: fechaSeleccionada }),
        });
        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        alert(
          `‚úÖ Caja cerrada.\nTotal del d√≠a: $${data.caja.totalDia.toLocaleString()}`
        );
      } catch (error) {
        console.error("Error cerrando caja:", error);
        alert("‚ùå Error al cerrar la caja.");
      }
    });

    cerrarCajaBtn.addEventListener("click", () => {
      alert("‚úÖ Caja cerrada correctamente.");
    });

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "login.html";
    });

    // === NUEVA SECCI√ìN DE REPORTES ===
    async function generarPDF(titulo, ordenes, periodoTexto) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text(titulo, 10, 15);
      doc.setFontSize(12);
      doc.text(periodoTexto, 10, 25);
      let y = 40;
      let total = 0;
      ordenes.forEach((orden, i) => {
        const productos = orden.productos.map(p => `${p.nombre} (${p.cantidad})`).join(", ");
        doc.text(`${i + 1}. Mesa: ${orden.mesa} | Total: $${orden.total}`, 10, y);
        y += 6;
        doc.text(`Productos: ${productos}`, 10, y);
        y += 10;
        total += orden.total;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });
      doc.text(`üí∞ Total general: $${total.toLocaleString()}`, 10, y + 10);
      doc.save(`${titulo.replace(/\s+/g, "_")}.pdf`);
    }

    reporteDiarioBtn.addEventListener("click", async () => {
      const fecha = fechaInput.value || new Date().toISOString().split("T")[0];
      try {
        const res = await fetch(`${API_BASE}/ordenes?fecha=${fecha}`);
        const ordenes = await res.json();
        await generarPDF("Reporte Diario", ordenes, `Fecha: ${fecha}`);
      } catch (error) {
        console.error("Error generando reporte diario:", error);
      }
    });

    reporteMensualBtn.addEventListener("click", async () => {
      const hoy = new Date();
      const mes = hoy.getMonth() + 1;
      const anio = hoy.getFullYear();
      try {
        const res = await fetch(`${API_BASE}/ordenes?mes=${mes}&anio=${anio}`);
        const ordenes = await res.json();
        await generarPDF("Reporte Mensual", ordenes, `Mes: ${mes}/${anio}`);
      } catch (error) {
        console.error("Error generando reporte mensual:", error);
      }
    });
  </script>

  <script type="module" src="caja.js"></script>
</body>
</html>