<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Caja</title>
  <link rel="stylesheet" href="styles/admin.css">
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f9f9f9;
      padding: 30px;
      color: #333;
    }

    h1 {
      color: #0984e3;
      text-align: center;
    }

    .filtros {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 20px 0;
    }

    input[type="date"],
    select {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      padding: 10px 20px;
      background-color: #0984e3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background-color: #065cb4;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }

    th {
      background: #0984e3;
      color: white;
    }

    .acciones {
      text-align: center;
      margin-top: 20px;
    }

    .total {
      font-size: 1.2em;
      font-weight: bold;
      color: #0984e3;
      margin-top: 15px;
      text-align: right;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="admin.html" id="nav-productos">Productos</a></li>
        <li><a href="caja.html" id="nav-caja">Caja</a></li>
        <li><button id="logoutBtn">Cerrar sesi√≥n</button></li>
      </ul>
    </nav>
  </header>

  <h1>üì¶ Caja</h1>

  <div class="filtros">
    <label for="fecha">Seleccionar fecha:</label>
    <input type="date" id="fecha" />
    <button id="buscar">Buscar √ìrdenes</button>
  </div>

  <table id="tablaOrdenes">
    <thead>
      <tr>
        <th>ID</th>
        <th>Cliente</th>
        <th>Productos</th>
        <th>Total</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="total" id="totalDia"></div>

  <div class="acciones">
    <button id="cerrarCaja">Cerrar Caja</button>
  </div>

  <!-- üëá Usa m√≥dulo para permitir imports en caja.js -->
  <script type="module">
    import { API_BASE } from "./config.js";

    const fechaInput = document.getElementById("fecha");
    const buscarBtn = document.getElementById("buscar");
    const cerrarCajaBtn = document.getElementById("cerrarCaja");
    const tablaBody = document.querySelector("#tablaOrdenes tbody");
    const totalDiaDiv = document.getElementById("totalDia");
    const logoutBtn = document.getElementById("logoutBtn");

    // üîì Cerrar sesi√≥n
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "login.html";
    });

    // üß≠ Capturar fecha desde URL (ej: ?fecha=2025-10-14)
    window.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const fechaURL = params.get("fecha");

      if (fechaURL) {
        fechaInput.value = fechaURL;
        buscarOrdenesPorFecha(fechaURL);
      }
    });

    // üîç Buscar √≥rdenes por fecha
    async function buscarOrdenesPorFecha(fechaSeleccionada) {
      if (!fechaSeleccionada) {
        alert("Por favor selecciona una fecha.");
        return;
      }

      try {
        const fechaISO = new Date(`${fechaSeleccionada}T00:00:00-05:00`).toISOString().split("T")[0];
        const response = await fetch(`${API_BASE}/por-fecha/${fechaISO}`);
        if (!response.ok) throw new Error(await response.text());

        const ordenes = await response.json();

        if (!Array.isArray(ordenes) || ordenes.length === 0) {
          tablaBody.innerHTML = `<tr><td colspan="5">No se encontraron √≥rdenes para esa fecha</td></tr>`;
          totalDiaDiv.textContent = "";
          return;
        }

        renderOrdenes(ordenes);
      } catch (error) {
        console.error("Error al buscar √≥rdenes:", error);
        alert("‚ùå Error al buscar las √≥rdenes del d√≠a.");
      }
    }

    buscarBtn.addEventListener("click", () => {
      buscarOrdenesPorFecha(fechaInput.value);
    });

    // üßæ Renderizar √≥rdenes
    function renderOrdenes(ordenes) {
      tablaBody.innerHTML = "";
      let total = 0;

      ordenes.forEach((orden) => {
        const fila = document.createElement("tr");
        const productos = orden.items.map((p) => `${p.nombre} (${p.cantidad})`).join(", ");
        const fechaLocal = new Date(orden.createdAt).toLocaleDateString("es-CO", { timeZone: "America/Bogota" });

        fila.innerHTML = `
          <td>${orden._id || "N/A"}</td>
          <td>${orden.cliente || "N/A"}</td>
          <td>${productos}</td>
          <td>$${orden.total.toLocaleString()}</td>
          <td>${fechaLocal}</td>
        `;

        total += orden.total;
        tablaBody.appendChild(fila);
      });

      totalDiaDiv.textContent = `Total del d√≠a: $${total.toLocaleString()}`;
    }

    // üí∞ Cerrar caja
    cerrarCajaBtn.addEventListener("click", async () => {
      const fechaSeleccionada = fechaInput.value;
      if (!fechaSeleccionada) return alert("Selecciona una fecha antes de cerrar la caja.");

      const confirmacion = confirm(`¬øSeguro que deseas cerrar la caja del d√≠a ${fechaSeleccionada}?`);
      if (!confirmacion) return;

      try {
        const response = await fetch(`${API_BASE}/cerrar-caja`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fecha: fechaSeleccionada }),
        });

        if (!response.ok) throw new Error(await response.text());

        const data = await response.json();
        alert(`‚úÖ Caja cerrada.\nTotal del d√≠a: $${data.caja.totalDia.toLocaleString()}`);
      } catch (error) {
        console.error("Error cerrando caja:", error);
        alert("‚ùå Error al cerrar la caja.");
      }
    });
  </script>
</body>
</html>
